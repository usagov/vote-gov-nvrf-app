# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/configuration-reference
version: 2.1
orbs:
  gh: circleci/github-cli@2.2.0
# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/configuration-reference/#jobs
jobs:
  fetch-nvrf:
    # Specify the execution environment. You can specify an image from Docker Hub or use one of our convenience images from CircleCI's Developer Hub.
    # See: https://circleci.com/docs/configuration-reference/#executor-job
    docker:
      - image: cimg/base:stable
    # Add steps to the job
    # See: https://circleci.com/docs/configuration-reference/#steps
    environment:
      URL: https://www.eac.gov/sites/default/files/eac_assets/1/6/Federal_Voter_Registration_ENG.pdf
    steps:
      #download pdf from
      - run: |
         curl -o Federal_Voter_Registration_ENG.pdf $URL
      #save pdf as an artifact
      - store_artifacts:
          path: Federal_Voter_Registration_ENG.pdf
          destination: /pdf-files
      - run: |
            artifacts=$(curl -X GET "https://circleci.com/api/v2/project/github/usagov/vote-gov-nvrf-app/$CIRCLE_BUILD_NUM/artifacts" \
            -H "Accept: application/json" \
            -u "$NVRF_PDF_WRITE:")
            # generate a heredoc in BASH_ENV
            echo "read -r -d '' STORED_ARTIFACTS \<< 'EOF_ARTIFACTS'" >> $BASH_ENV
            echo "$artifacts" >> $BASH_ENV
            echo "EOF_ARTIFACTS" >> $BASH_ENV
  create-pr:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - gh/install
      - run:
          name: Create Pull Request
          command: |
            echo $NVRF_PDF_WRITE | tee /tmp/key.txt
            gh auth login --with-token < /tmp/key.txt
            gh pr create --title "test pr" --body "checking to see if this works"

    # IDEA: if the new pdf is the same as the old PDF, automatically merge PR

# Orchestrate jobs using workflows
# See: https://circleci.com/docs/configuration-reference/#workflows
workflows:
  update-nvrf-workflow:
    jobs:
      - fetch-nvrf
      - create-pr:
          requires:
            - fetch-nvrf
